name: Deploy Pixel Ecosystem to Production

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        default: false
      skip_build:
        description: 'Skip build (use existing artifacts)'
        required: false
        default: false

env:
  VPS_USER: pixel
  VPS_HOST: pixel.xx.kg
  NODE_VERSION: '20'
  BUN_VERSION: '1.1.0'
  PNPM_VERSION: '9'

jobs:
  build-and-deploy:
    name: Build All Services & Deploy to VPS
    runs-on: ubuntu-latest
    
    steps:
      # === Checkout with Submodules ===
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT_FOR_SUBMODULES }}
          submodules: recursive
          fetch-depth: 0
      
      # === Setup Runtimes ===
      - name: Install system dependencies
        run: apt-get update && apt-get install -y unzip curl
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
      
      - name: Setup pnpm
        run: npm install -g pnpm@${{ env.PNPM_VERSION }}
      
      - name: Cache Dependencies
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            */node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      # === Install Root Dependencies ===
      - name: Install Root Dependencies
        run: pnpm install
        continue-on-error: true
      
      # === Install Submodule Dependencies ===
      - name: Install LNPixels Dependencies
        if: ${{ !inputs.skip_build }}
        run: |
          cd lnpixels
          pnpm install
          cd api && npm install
          cd ../lnpixels-app && npm install
        continue-on-error: true
      
      - name: Install Pixel Agent Dependencies
        if: ${{ !inputs.skip_build }}
        run: |
          cd pixel-agent
          npm install
        continue-on-error: true
      
      - name: Install Pixel Landing Dependencies
        if: ${{ !inputs.skip_build }}
        run: |
          cd pixel-landing
          npm install
        continue-on-error: true
      
      - name: Install Syntropy Core Dependencies
        if: ${{ !inputs.skip_build }}
        run: |
          cd syntropy-core
          bun install
        continue-on-error: true
      
      # === Build All Services ===
      - name: Build LNPixels (API + App)
        if: ${{ !inputs.skip_build }}
        run: |
          cd lnpixels
          pnpm run build || echo "LNPixels build failed"
        continue-on-error: true
      
      - name: Build Pixel Agent
        if: ${{ !inputs.skip_build }}
        run: |
          cd pixel-agent
          npm run build || echo "Pixel Agent build failed"
        continue-on-error: true
      
      - name: Build Pixel Landing
        if: ${{ !inputs.skip_build }}
        run: |
          cd pixel-landing
          npm run build || echo "Pixel Landing build failed"
        continue-on-error: true
      
      - name: Build Syntropy Core
        if: ${{ !inputs.skip_build }}
        run: |
          cd syntropy-core
          bun run build || echo "Syntropy Core build failed"
        continue-on-error: true
      
      # === Upload Artifacts ===
      - name: Upload Build Artifacts
        if: ${{ !inputs.skip_build }}
        uses: actions/upload-artifact@v4
        with:
          name: pixel-build-artifacts
          path: |
            lnpixels/api/dist
            lnpixels/lnpixels-app/.next
            pixel-agent/dist
            pixel-agent/character.json
            pixel-landing/.next
            syntropy-core/dist
          retention-days: 7
      
      # === Test Services ===
      - name: Test Services
        if: ${{ !inputs.skip_tests }}
        run: |
          pnpm run test || echo "Tests completed with warnings"
        continue-on-error: true
      
      # === Deploy to VPS (only on master push) ===
      - name: Deploy to VPS
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts
          
          # Pre-deployment backup
          echo "Creating backup before deployment..."
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
            "cd /home/pixel && ./autonomous-backup.sh || echo 'Backup script not found'"
          
          # Sync code (excluding large folders)
          echo "Syncing code to VPS..."
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'logs' \
            --exclude '*.log' \
            --exclude '.env' \
            --exclude 'backups' \
            --exclude '.next' \
            --exclude 'dist' \
            ./ ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/home/pixel/
          
          # Install dependencies on VPS
          echo "Installing dependencies on VPS..."
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
            "cd /home/pixel && \
             pnpm install && \
             cd lnpixels && pnpm install && \
             cd ../pixel-agent && npm install && \
             cd ../pixel-landing && npm install && \
             cd ../syntropy-core && bun install"
          
          # Build on VPS
          echo "Building on VPS..."
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
            "cd /home/pixel && \
             cd lnpixels && pnpm run build && \
             cd ../pixel-agent && npm run build && \
             cd ../pixel-landing && npm run build && \
             cd ../syntropy-core && bun run build"
      
      # === Restart PM2 ===
      - name: Restart PM2
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: |
          echo "Restarting PM2 processes..."
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
            "cd /home/pixel && pm2 restart all"
          
          echo "Waiting for services to start..."
          sleep 20
          
          # Check PM2 status
          echo "Checking PM2 status..."
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
            "pm2 status"
      
      # === Health Verification ===
      - name: Verify Services Health
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: |
          echo "Checking API health (port 3000)..."
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
            "curl -f http://localhost:3000/health || echo 'API not healthy'"
          
          echo "Checking landing page (port 3001)..."
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
            "curl -f http://localhost:3001/ || echo 'Landing not healthy'"
          
          echo "Checking app page (port 5173)..."
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
            "curl -f http://localhost:5173/ || echo 'App not healthy'"
          
          echo "Checking PM2 status (includes Syntropy)..."
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
            "pm2 status"
          
          echo "NOTE: Syntropy runs via PM2 (bun src/index.ts) - NO HTTP endpoint"
      
      # === Deployment Summary ===
      - name: Deployment Summary
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: |
          echo "âœ… Deployment Complete!"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"
          echo "Actor: ${{ github.actor }}"
          echo "Timestamp: ${{ github.event.head_commit.timestamp }}"
