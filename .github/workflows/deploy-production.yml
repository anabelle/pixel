name: Deploy Pixel Ecosystem to Production

on:
  push:
    branches: [master]

env:
  VPS_USER: pixel
  VPS_HOST: pixel.xx.kg

jobs:
  deploy_to_vps:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT_FOR_SUBMODULES }}
          submodules: recursive
          fetch-depth: 0

      - name: Build Validation (Local)
        run: |
          # Verify that the composition is valid and images compile
          docker compose config
          docker compose build --parallel

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Deploy to VPS
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: |
          # Stash any Syntropy changes on VPS before deploying
          ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "cd /pixel && git stash push -m 'pre-deploy-stash' -- CONTINUITY.md 2>/dev/null || true"
          
          rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'logs' \
            --exclude 'data' \
            --exclude 'backups' \
            --exclude 'certbot' \
            --exclude 'CONTINUITY.md' \
            --exclude 'pixel-landing/public/audit.json' \
            --exclude 'pixel-landing/public/syntropy.json' \
            ./ ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/pixel/

      - name: Atomic Blue/Green Deploy
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "/pixel/scripts/safe-deploy.sh"
