name: Deploy Pixel Ecosystem to Production

on:
  push:
    branches: [master]

env:
  VPS_USER: pixel
  VPS_HOST: pixel.xx.kg
  NODE_VERSION: '20'
  BUN_VERSION: '1.1.0'
  PNPM_VERSION: '9'

jobs:
  build_and_deploy:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT_FOR_SUBMODULES }}
          submodules: recursive
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y \
            unzip curl \
            python3 make g++ \
            build-essential \
            libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup pnpm
        run: npm install -g pnpm@${{ env.PNPM_VERSION }}

      - name: Install Root Dependencies
        run: pnpm install

      - name: Install LNPixels Dependencies
        run: |
          cd lnpixels
          pnpm install

      - name: Install LNPixels API Dependencies
        run: |
          cd lnpixels/api
          npm install --ignore-scripts

      - name: Install LNPixels App Dependencies
        run: |
          cd lnpixels/lnpixels-app
          npm install --legacy-peer-deps

      - name: Install Pixel Agent Dependencies
        run: |
          cd pixel-agent
          npm install --legacy-peer-deps

      - name: Install Pixel Landing Dependencies
        run: |
          cd pixel-landing
          pnpm install

      - name: Install Syntropy Core Dependencies
        run: |
          cd syntropy-core
          bun install

      - name: Build LNPixels (API + App)
        run: |
          cd lnpixels/api
          npm run build
          cd ../lnpixels-app
          npm run build

      - name: Build Pixel Agent
        run: |
          cd pixel-agent
          npm run build

      - name: Build Pixel Landing
        run: |
          cd pixel-landing
          npm run build

      - name: Build Syntropy Core
        run: |
          cd syntropy-core
          bun run build

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pixel-build-artifacts
          path: |
            lnpixels/api/dist
            lnpixels/lnpixels-app/.next
            pixel-agent/dist
            pixel-agent/character.json
            pixel-landing/.next
            syntropy-core/dist
          retention-days: 7

      - name: Deploy to VPS
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts

          # Sync code (excluding large folders)
          echo "Syncing code to VPS..."
          rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'logs' \
            --exclude '*.log' \
            --exclude '.env' \
            --exclude 'backups' \
            --exclude '.next' \
            --exclude 'dist' \
            ./ ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/home/pixel/

          # Install dependencies on VPS
          echo "Installing dependencies on VPS..."
          ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << 'ENDSSH'
            cd /home/pixel
            pnpm install
            cd lnpixels && pnpm install
            cd api && npm install --ignore-scripts
            cd ../lnpixels-app && npm install --legacy-peer-deps
            cd ../../pixel-agent && npm install --legacy-peer-deps
            cd ../pixel-landing && pnpm install
            cd ../syntropy-core && bun install
          ENDSSH

          # Build on VPS
          echo "Building on VPS..."
          ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << 'ENDSSH'
            cd /home/pixel
            cd lnpixels/api && npm run build
            cd ../lnpixels-app && npm run build
            cd ../../pixel-agent && npm run build
            cd ../pixel-landing && npm run build
            cd ../syntropy-core && bun run build
          ENDSSH

      - name: Restart PM2
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << 'ENDSSH'
            cd /home/pixel
            pm2 restart all
            sleep 10
            pm2 status
          ENDSSH

      - name: Verify Services Health
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: |
          echo "Checking API health (port 3000)..."
          ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "curl -f http://localhost:3000/health || echo 'API not healthy'"

          echo "Checking landing page (port 3001)..."
          ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "curl -f http://localhost:3001/ || echo 'Landing not healthy'"

          echo "Checking app page (port 5173)..."
          ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "curl -f http://localhost:5173/ || echo 'App not healthy'"

          echo "Checking PM2 status..."
          ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "pm2 status"
