services:
  # LNPixels API
  api:
    build:
      context: ./lnpixels/api
    user: "1000:1000"
    ports:
      - "127.0.0.1:3000:3000"
    env_file:
      - .env
    volumes:
      # Mount directory instead of individual files for SQLite WAL mode compatibility
      - ./data/lnpixels:/app/data
      - ./backups:/app/backups
    environment:
      - PORT=3000
      - NODE_ENV=production
      - DB_PATH=/app/data/pixels.db
      - POSTGRES_URL=postgresql://postgres:postgres@postgres:5432/pixel_agent
      - API_URL=http://api:3000/api
    networks:
      - pixel-net
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://127.0.0.1:3000/api/stats" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # [V2 MIGRATION] Removed: narrative-correlator, temporal-precision, docu-gardener
  # These V1 services are no longer needed. Recoverable from git history.

  # LNPixels Web App (Canvas)
  web:
    build:
      context: ./lnpixels/lnpixels-app
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://127.0.0.1:3000/api}
    ports:
      - "127.0.0.1:3002:3002"
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - HOSTNAME=0.0.0.0
    networks:
      - pixel-net
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://127.0.0.1:3002/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

  # Pixel Landing Page
  landing:
    build:
      context: ./pixel-landing
      args:
        - NEXT_PUBLIC_CANVAS_URL=${NEXT_PUBLIC_CANVAS_URL:-https://ln.pixel.xx.kg}
        - NEXT_PUBLIC_AGENT_HANDLE=${NEXT_PUBLIC_AGENT_HANDLE:-@PixelSurvivor}
        - NEXT_PUBLIC_LIGHTNING_ADDRESS=${NEXT_PUBLIC_LIGHTNING_ADDRESS:-sparepiccolo55@walletofsatoshi.com}
        - NEXT_PUBLIC_BITCOIN_ADDRESS=${NEXT_PUBLIC_BITCOIN_ADDRESS:-bc1q7e33r989x03ynp6h4z04zygtslp5v8mcx535za}
    ports:
      - "127.0.0.1:3001:3001"
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - HOSTNAME=0.0.0.0
    networks:
      - pixel-net
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://127.0.0.1:3001/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

  # Pixel Agent (Eliza)
  agent:
    build:
      context: ./pixel-agent
    user: "1000:1000"
    ports:
      - "127.0.0.1:3003:3003"
    env_file:
      - .env
    volumes:
      - ./logs:/app/logs
      - ./data/eliza:/app/.eliza
    environment:
      - NODE_ENV=production
      - LNPIXELS_WS_URL=http://api:3000
      - PORT=3003
      - CI=true
      # Use external PostgreSQL instead of embedded PGLite to prevent corruption
      - POSTGRES_URL=postgresql://postgres:postgres@postgres:5432/pixel_agent
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/pixel_agent
    networks:
      - pixel-net
    stop_grace_period: 30s
    depends_on:
      api:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://127.0.0.1:3003/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 800M
        reservations:
          memory: 400M

  # Syntropy Core (AI Orchestration)
  syntropy:
    build:
      context: ./syntropy-core
    # Run as host user to avoid root-owned files, but add docker group for socket access
    user: "1000:1000"
    group_add:
      - "${DOCKER_GID:-999}" # docker group GID
    env_file:
      - .env
    volumes:
      - .:/pixel
      - /var/run/docker.sock:/var/run/docker.sock
      # SSH keys for GitHub push access (deploy key)
      - ~/.ssh/deploy_key:/tmp/.ssh/deploy_key:ro
      - ~/.ssh/config:/tmp/.ssh/config:ro
      - ~/.ssh/known_hosts:/tmp/.ssh/known_hosts:ro
    environment:
      - NODE_ENV=production
      - PIXEL_ROOT=/pixel
      - PIXEL_AGENT_DIR=/pixel/pixel-agent
      - DB_PATH=/pixel/data/lnpixels/pixels.db
      - LOG_PATH=/pixel/logs/agent.log
      - AUDIT_LOG_PATH=/pixel/pixel-landing/public/audit.json
      - HOME=/tmp
      # HOST_PIXEL_ROOT is the absolute path on the host machine.
      # Syntropy passes this to docker compose when spawning workers.
      - HOST_PIXEL_ROOT=${HOST_PIXEL_ROOT:-${PWD}}
      # Git authentication via SSH deploy key
      - GIT_SSH_COMMAND=ssh -i /tmp/.ssh/deploy_key -o UserKnownHostsFile=/tmp/.ssh/known_hosts -o StrictHostKeyChecking=no
      # Security: Prevent worker spawn cascade (OOM protection)
      - MAX_CONCURRENT_WORKERS=${MAX_CONCURRENT_WORKERS:-2}
    networks:
      - pixel-net
    depends_on:
      api:
        condition: service_healthy
      agent:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-sf", "http://127.0.0.1:3000/health" ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # Postgres Database - External DB for ElizaOS (prevents PGLite corruption)
  postgres:
    image: pgvector/pgvector:pg15
    ports:
      - "127.0.0.1:5432:5432"
    environment:
      - POSTGRES_DB=pixel_agent
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - pixel-net
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres -d pixel_agent" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 300M
        reservations:
          memory: 150M

  # pgAdmin - PostgreSQL Web GUI (not started by default)
  # Start manually: docker compose --profile tools up -d pgadmin
  # Access via SSH tunnel: ssh -L 5050:127.0.0.1:5050 user@vps
  pgadmin:
    profiles: [ "tools" ]
    image: dpage/pgadmin4:latest
    ports:
      - "127.0.0.1:5050:80"
    environment:
      - PGADMIN_DEFAULT_EMAIL=pixel@example.com
      - PGADMIN_DEFAULT_PASSWORD=pixel123
      - PGADMIN_CONFIG_SERVER_MODE=False
      - PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED=False
      - PGADMIN_SERVER_JSON_FILE=/pgadmin4/servers.json
    volumes:
      - ./data/pgadmin:/var/lib/pgadmin
      - ./data/pgadmin-servers.json:/pgadmin4/servers.json:ro
    networks:
      - pixel-net
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    command: [ "nginx", "-g", "daemon off; error_log /dev/null emerg;" ]
    logging:
      driver: "none"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
    networks:
      - pixel-net
    depends_on:
      - api
      - web
      - landing
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://127.0.0.1/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 32M

  # [V2 MIGRATION] Removed: velocity-monitor, opencode-logs, vps-monitor,
  # bitcoin, lightning, certbot, backup
  # These V1 services are no longer needed. Recoverable from git history.
  # Lightning replaced by NWC/Alby. Certbot replaced by Caddy auto-HTTPS.

networks:
  pixel-net:
    driver: bridge
